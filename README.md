# MicroPython 极速光电组智能车控制（串级PID + CCD循迹 + 十字 + 环岛）

本项目是基于 MicroPython 的智能车控制系统，实现了从 **传感器采集 → 误差计算 → 控制算法 → 电机驱动** 的完整闭环。
代码支持稳定通过 **直道循迹、十字路口、环岛** 等赛道结构，并具备无线串口调试与波形输出能力。
## 1. 我的角色与贡献
- 智能车项目 **队长 / 软件负责人**
- 搭建主程序框架与核心算法结构
- 完成串级控制：速度环 → 角度环 → 角速度环（平衡/姿态稳定）
- 完成 CCD 循迹（差比和法提取边界）、十字路口识别与状态切换
- 完成环岛检测与出环策略（结合 CCD 宽度、边界丢失与 IMU yaw 积分）
- 完成编码器速度滤波、电机限幅保护、无线示波器调试输出

---

## 2. 硬件与外设（来自代码实现）
- **主控环境**：MicroPython（赛道车平台）
- **电机驱动**：PWM 控制（左右电机独立）
- **编码器**：左右轮速度采集 + 低通滤波
- **CCD**：TSL1401 线阵 CCD（12bit）
- **IMU**：IMU963RX（加速度 + 陀螺）
- **通信调试**：无线串口 WIRELESS_UART（460800）、有线串口 UART

---

## 3. 系统架构概览
整体控制分为两条主线：

### A. 平衡/姿态控制（串级控制）
速度环（Encoder） → 角度环（Pitch） → 角速度环（Gyro）

对应代码函数：
- `speed_PID()`：速度环（Encoder）
- `angle_PD()`：角度环（Pitch，四元数解算）
- `gyro_PD()`：角速度环（Gyro）

### B. 方向控制（循迹/策略）
CCD 寻迹得到偏差 → 转向控制输出 → 与平衡输出合成

对应代码函数：
- `ccd1_get_boundary()`、`ccd2_get_boundary()`：边界提取与中线计算
- `turn()`：转向环（含环岛/十字逻辑补偿）

---

## 4. CCD寻迹算法（差比和法）
本项目使用“差比和法”检测边界上升沿/下降沿：

value = (ccd[i] - ccd[i+4]) / (ccd[i] + ccd[i+4] + 1)

- 上升沿/下降沿可用于判断左右边界
- 中线 = (左边界 + 右边界) / 2
- 支持丢线补线策略：
  - 左丢线：用右边界 - 赛道宽度补左边界
  - 右丢线：用左边界 + 赛道宽度补右边界
  - 全丢线：强制中线为默认值（64）

---

## 5. 十字路口识别（状态机）
代码实现了一个简单但有效的状态机：

- `STRAIGHT`：正常循迹
- `CROSSROAD`：十字路口模式（强制使用固定边界，避免误判）

进入十字路口判据（代码逻辑）：
- CCD 双边界全丢线，或 CCD 总能量异常增大

进入后保持约 500ms，再切回 `STRAIGHT`，提升稳定性。

---

## 6. 环岛识别与通过策略（本项目亮点）
环岛检测使用多条件组合（比“单一阈值判断”更稳定）：
- 赛道宽度异常增大（远端/近端 CCD road_len 变大）
- 边界丢失模式（左丢线/右丢线）
- IMU yaw 积分辅助判断（转向角累计达到阈值）

关键函数：
- `huandao_check()`
- `lefthuan()` / `righthuan()`

环岛通过过程包含：
- 识别进环方向（左环/右环）
- 进环状态切换（annual_state）
- 出环判据（赛宽恢复到正常范围）
- 出环延时退出（防止刚出环又误判）

---

## 7. 控制策略（串级PID + 转向输出合成）
### 7.1 串级控制（平衡稳定）
- 速度环输出作为角度环输入（抑制速度扰动）
- 角度环输出作为角速度环输入（抑制姿态变化）
- 最终角速度环输出作为电机基础控制量（duty）

### 7.2 转向控制（循迹 + 非线性项 + 陀螺补偿）
转向输出包含：
- 线性项：`location * Kp_turn`
- 非线性项：`abs(location) * location * Kp_turn2`（大误差时加强纠偏）
- 微分项：`(location - location_last) * Kd_turn`
- 陀螺补偿：`gz * Kd_turn2`

最终：
- 左电机 = 平衡输出 + 转向输出
- 右电机 = 平衡输出 - 转向输出

并加入电机限幅（±4000）避免过驱。

---

## 8. 工程化细节
✅ 编码器速度低通滤波（避免速度环抖动）  
✅ 积分限幅（防止积分饱和）  
✅ 上电启动按键控制（start_zhili）  
✅ 10ms 定时器任务分离（ticker）  
✅ 无线示波器通道输出（便于调参）  
✅ 手动急停开关（防止程序异常无法退出）

---



